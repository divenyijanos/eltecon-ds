---
title: "Eltecon Data Science Course by Emarsys"
subtitle: "Measuring effect through experimenting"
author: "András Bérczi"
date: "October 7, 2020"
output:
  beamer_presentation:
    colortheme: dolphin
    fonttheme: structurebold
    theme: AnnArbor
    # toc: true
    slide_level: 2
---

```{r setup, include=FALSE}
# knitr::opts_knit$set(root.dir = '..')

library(knitr)
library(data.table)
library(magrittr)
library(ggplot2)
```

## About me

- Background in Economics
- Works as Data Scientist @ Emarsys

# Homeworks from last week

# Why talk about effect measurement in Data Science?

# We want to understand the effect of a new feature

# What is an effect?

## What is an effect?

Added value of a treatment

## Why do we want to measure the effect?

To decide if our treatment works

# What to experiment on?

## What is worth experimenting?

- **Based on customer's need**
- Validated by data based research
    - Will the algo work?
    - Does it scale?
    - Cost of the feature?
- Make sure you understand your feature/algorithm!


## Measure the effect of what?

- Adding a new feature to the software
- Change in the algorithm
- Change on the website/UI
- etc.

## How can we measure the effect?

- Simulation
- Based on historical data
- **Experimenting**

# How do we experiment?

## Setup

- Define the goal
- Definte KPIs
    - How much added value does it bring to the user?
- Measure one feature at a time
- Split contacts *randomly* into control and treatment group(s)
- Do not change parameters during the experiment

## What are good KPIs?

Treatment receives personalized email, control receives "standard" email.
```{r example-for-KPIs, echo = FALSE}
data.table(
    id = c(1:6, "...", 100),
    group = c(
        "control", "treatment", "control", "treatment",
        "control", "treatment", "...", "treatment"),
    did_open = c(0, 0, 1, 0, 1, 1, "...", 1),
    did_click = c(0, 0, 1, 0, 0, 1, "...", 0),
    sales_amount = c(0, 0, 30, 0, 50, 12, "...", 0)
) %>% kable()
```

## How to calculate the effect

$$Uplift_{KPI} = \frac{KPI_{treatment}}{KPI_{control}} - 1$$

## Calculate the effect for the first period!

Use `experiment_results.csv`
Enter your results in socrative!

## Calculate the effect for the second period and plot the results!

Use `experiment_results.csv`
When you are done, share your screen showing the plot!

The *design* should look something like this:
```{r effect-example, echo=FALSE, out.width='60%', fig.align='center'}
dt <- data.table(
    group = c("control", "treatment"),
    open_rate = c(0.1, 0.12)
)
ggplot(dt, aes(x = group, y = open_rate)) +
    geom_col() +
    scale_y_continuous(labels = scales::percent) +
    labs(
        title = "Open rates for second period",
        subtitle = paste0("Uplift: 20%"),
        x = "", y = "Open rate"
    )
```

## Calculate the effect for the whole period and plot the results!

When you are done, share your screen showing the plot!

*Do you notice anything weird?*
```{r simpsons-paradox, echo = FALSE, include = FALSE}
dt <- fread("experiment_result.csv")

dt[, .(.N, mean(did_open)), keyby = .(period, group)]
dt[, .(.N, mean(did_open)), group]
```

## One way to aggregate the effect

$$KPI_{treatment} = \frac{\sum_{i = 1}^{n}KPI_{treatment, i} * SampleSize_{i}}{\sum_{i = 1}^{n}{SampleSize_{i}}}$$

$$KPI_{control} = \frac{\sum_{i = 1}^{n}KPI_{control, i} * SampleSize_{i}}{\sum_{i = 1}^{n}{SampleSize_{i}}}$$

$$Uplift_{KPI} = \frac{KPI_{treatment}}{KPI_{control}} - 1$$
, where *n* is the number of unit levels.

## Calculate the effect for the whole period and plot the results!

Weight the open rates by the number of contacts present in the period!

When you are done, share your screen showing the plot!

## Plot the effect (uplift) over time!

Use `experiment_results_over_time.csv`

When you are done, share your screen showing the plot!

The *design* should look something like this:
```{r effect-over-time-example, echo=FALSE, out.width='60%', fig.align='center'}

dt <- data.table(
    date = as.Date(c(
        "2020-01-01", "2020-02-01", "2020-03-01",
        "2020-04-01", "2020-05-01", "2020-06-01"
    )),
    uplift = c(0.1, 0.05, 0.07, -0.2, -0.12, 0.1)
)
ggplot(dt, aes(date, uplift)) +
    geom_line() +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::percent) +
    labs(
        title = "Change in uplift over time",
        x = "Uplift", y = ""
    )

```
## How to present

```{r, echo = FALSE, out.width='80%', fig.align='center'}
include_graphics("figures/uplift.png")
```

# How to present: [Shiny app from Emarsys](https://rserver.service.emarsys.net/app/sto-monitoring)

# Homework for next week and presenters

